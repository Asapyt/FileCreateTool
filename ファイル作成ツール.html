<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>テキスト出力ツール</title>
<style>
  textarea {
     width: 500px;
    max-width: 100%;
    height: 80px;
    margin: 0 0 20px 0;   /* ← 左寄せ */
    display: block;
  }
</style>
</head>
<body>

<h1>テキスト出力ツール</h1>
<button id="selectFolder">作業フォルダ選択</button>
<div id="content"></div>

<script>
let dirHandle;
const TEMPLATE_NAME = "template.txt";

/* フォルダ選択 */
document.getElementById("selectFolder").onclick = async () => {
  try {
    dirHandle = await window.showDirectoryPicker();
    checkTemplate();
  } catch (error) {
    alert('フォルダを選択してください。');
    return false;
    
  }
};

/* テンプレート存在確認 */
async function checkTemplate() {

  try {

    const handle = await dirHandle.getFileHandle(TEMPLATE_NAME);
    const file = await handle.getFile();
    const text = await file.text();

    if (!text || text.trim() === "") {
      throw new Error("empty template");
    }

    showOutputScreen(text);

  } catch (error) {

    /* -------------------------
       ファイルが存在しないだけ
       → 初回なのでエラー出さない
    ------------------------- */
    if (error.name === "NotFoundError") {
      showTemplateCreator();
      return;
    }

    /* -------------------------
       それ以外は壊れている
    ------------------------- */
    alert("テンプレートファイル読み込み時にエラーが発生したため、再度作成してください。");

    showTemplateCreator();
  }
}


/* -----------------------------
   テンプレート作成画面
----------------------------- */
function showTemplateCreator() {

  document.getElementById("content").innerHTML = `
    <h2>テンプレート作成</h2>

    <label>出力ファイル名：
      <input id="filename">
    </label><br>

    <label id="getDate">
      <input type="button" id="addDate" value="月日を先頭に付ける">
    </label><br><br>

    <h3>目次</h3>
    <div id="toc-area">
      <div>
        <input type="text" name="toc" placeholder="目次">
        <button type="button" class="remove-toc">削除</button>
      </div>
    </div>

    <button id="addTocBtn">目次追加</button><br><br>
    <button id="saveTemplateBtn">テンプレート保存</button>
  `;

  document.getElementById("selectFolder").style.display="none";

  /* -----------------------------
     ここでイベント登録
  ----------------------------- */

  document
    .getElementById("addDate")
    .addEventListener("click", date_math);

  document
    .getElementById("addTocBtn")
    .addEventListener("click", addToc);

  document
    .getElementById("saveTemplateBtn")
    .addEventListener("click", saveTemplate);

  /* 削除ボタン（最初の1個） */
  document
    .querySelector(".remove-toc")
    .addEventListener("click", function() {
      this.parentElement.remove();
    });
}

function addToc() {

  const currentCount =
    document.querySelectorAll('input[name="toc"]').length;

  if (currentCount >= 10) {
    alert("目次は10個まで追加できます。");
    return;
  }

  const div = document.createElement("div");

  div.innerHTML = `
    <input type="text" name="toc" placeholder="目次">
    <button type="button" class="remove-toc">削除</button>
  `;

  document.getElementById("toc-area").appendChild(div);

  /* 追加した削除ボタンにイベント登録 */
  div.querySelector(".remove-toc")
     .addEventListener("click", function() {
        div.remove();
     });
}


function removeToc(button) {
  const div = button.parentElement;
  div.remove();
}

function date_math(){

    const filenameInput = document.getElementById("filename");

    // 既にyyyymm_が付いていなければ付ける
    if (!filenameInput.value.startsWith("yyyymm_")) {
        filenameInput.value = "yyyymm_" + filenameInput.value;
    }

    const div = document.createElement("div");

    const ym = new Date();
    ym.setMonth(ym.getMonth()-1);

    const year = ym.getFullYear();
    const month = String(ym.getMonth()+1).padStart(2,"0");

    div.innerHTML = `
      <label>年月</label><br>
      <input type="text" maxlength="4" id="year" value="${year}">
      <input type="text" maxlength="2" id="month" value="${month}">
    `;

    document.getElementById("getDate").appendChild(div);

    document.getElementById("addDate").style.display="none";
    document.getElementById("addDate").disabled=true;
}


function hasInvalidFilenameChars(name) {
  // File System Access API で使えない文字
  const invalidPattern = /[\\\/:*?"<>|\r\n\t]/;
  return invalidPattern.test(name);
}
async function saveTemplate() {
  let filename = document.getElementById("filename").value;

  if (!filename && (!document.getElementById("year") && !document.getElementById("month"))) {
    alert("ファイル名を入力してください");
    return;
  }

  if (hasInvalidFilenameChars(filename)) {
    alert('ファイル名に使用できない文字が含まれています。\n\\ / : * ? " < > | は使用できません。');
    return;
  }

  if (!filename.endsWith(".txt")) filename += ".txt";

if (filename.startsWith("yyyymm_")) {

    const yearInput = document.getElementById("year");
    const monthInput = document.getElementById("month");

    if (!yearInput || !monthInput) {
        alert("ファイル名が不正です。");
        return;
    }

    const year = yearInput.value;
    const month = monthInput.value.padStart(2,"0");

    if (!/^\d{4}$/.test(year) || year < 2000 || year > 2100) {
        alert("ファイル名が不正です。");
        return;
    }

    if (!/^\d{2}$/.test(month) || month < "01" || month > "12") {
        alert("ファイル名が不正です。");
        return;
    }

    const realYM = `${year}${month}_`;
    filename = filename.replace("yyyymm_", realYM);
}

// ① 取得
const tocInputs = [...document.querySelectorAll('input[name="toc"]')];

/* ② 空欄削除 */
tocInputs.forEach(input => {
  if (!input.value.trim()) {
    input.parentElement.remove();
  }
});

// ③ 削除後に再取得（別変数にする）
const cleanedTocInputs =
  [...document.querySelectorAll('input[name="toc"]')];

const tocs = cleanedTocInputs.map(i => i.value.trim());

// ④ 0件チェック
if (tocs.length === 0) {
  alert("目次を1つ以上入力してください。");
  return;
}

// ⑤ 重複チェック
const unique = new Set(tocs);

if (unique.size !== tocs.length) {
  const confirmResult =
    confirm("目次に重複があります。このまま保存しますか？");

  if (!confirmResult) {
    return;
  }
}

  const content =
`#filename
${filename}

#heading
${tocs.join("\n")}`;

  const handle = await dirHandle.getFileHandle(TEMPLATE_NAME, { create: true });
  const writable = await handle.createWritable();
  await writable.write(content);
  await writable.close();

  alert("テンプレートを作成しました");
  showOutputScreen(content);
}

/* -----------------------------
   テキスト出力画面
----------------------------- */
function showOutputScreen(text) {

  try {

    /* --------------------------
       #filename 取得
    --------------------------- */
    const filenameMatch = text.match(/#filename\n([\s\S]*?)\n\n/);
    if (!filenameMatch) {
      throw new Error("filename not found");
    }

    const filename = filenameMatch[1].trim();

    if (!isValidFilename(filename)) {
      throw new Error("invalid filename");
    }

    /* --------------------------
       #heading 取得
    --------------------------- */
    const headingMatch = text.match(/#heading\n([\s\S]*)/);
    if (!headingMatch) {
      throw new Error("heading not found");
    }

    const tocText = headingMatch[1];
    const items = tocText.split("\n").filter(v => v);

    if (items.length === 0) {
      throw new Error("no headings");
    }

    /* --------------------------
       画面生成
    --------------------------- */

    let html = `<h2>出力ファイル：${filename}</h2>`;

    items.forEach(item => {
      html += `
        <div class="section">
          <h3>${item}</h3>

          <label>
            <input type="checkbox"
                   class="subhead-check"
                   onchange="toggleSubhead(this)">
            <span class="subhead-label">小見出しをつける</span>
          </label>

          <input type="text"
                 class="subhead-input"
                 placeholder="小見出し"
                 style="display:none;">

          <textarea data-title="${item}"></textarea>
        </div>
      `;
    });

    html += `<button onclick="saveOutput('${filename}')">保存</button>`;
    document.getElementById("content").innerHTML = html;

  } catch (error) {

    alert("テンプレートファイル読み込み時にエラーが発生したため、再度作成してください。");

    showTemplateCreator();
  }
}


function toggleSubhead(checkbox) {
  // チェックボックスが属するセクション出ないなら処理を終了する
  const section = checkbox.closest(".section");
  if(!section) return;

  const input = section.querySelector(".subhead-input");
  const label = section.querySelector(".subhead-label");
  if(!input) return;

  if (checkbox.checked) {
    input.style.display = "inline-block";
    input.focus();

    // 操作しているセクションのラベルだけを消す
    if(label) label.style.display = "none";

  } else {
    input.style.display = "none";
    input.value = ""; // OFF時は小見出し消す

    // 操作しているセクションのラベルだけ戻す
    if(label) label.style.display = "inline";
  }
}

async function saveOutput(filename) {

  if (!isValidFilename(filename)) {
      alert("ファイル名が不正です。");
      return;
  }
  
  const textareas = document.querySelectorAll("textarea");
  let output = "";

textareas.forEach(ta => {
  const section = ta.closest(".section");
  const subhead = section.querySelector(".subhead-input").value;

  output += `【${ta.dataset.title}】\n`;

  if (subhead) {
    output += `・${subhead}\n`;
  }

  const lines = ta.value.split("\n");
lines.forEach(line => {
  output += `    ${line}\n`;
});
output += "\n";

});

  const handle = await dirHandle.getFileHandle(filename, { create: true });
  const writable = await handle.createWritable();
  await writable.write(output);
  await writable.close();

  alert("ファイルを出力しました");
}

//ファイル名チェック
function isValidFilename(name) {

  if (!name) return false;

  if (hasInvalidFilenameChars(name)) return false;

  if (!name.endsWith(".txt")) return false;

  return true;
}

</script>

</body>
</html>
